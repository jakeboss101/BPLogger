<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Home Screen Icon -->
  <link rel="apple-touch-icon" sizes="180x180" href="bp-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="bp-icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="bp-icon.png">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>BP Logger</title>
  <!-- ✅ Makes home screen name show as “BP” -->
  <meta name="apple-mobile-web-app-title" content="BP">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root {
      --accent: #2196f3;
      --danger: #f44336;
      --bg: #fafafa;
      --card-bg: #fff;
      --late-bg: #e0e0e0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 16px;
      color: #333;
      text-align: center;
    }

    h2 {
      text-align: center;
      margin: 12px 0 18px;
      font-size: 28px;
    }

    video, canvas, #photoPreview, button {
      width: 100%;
      margin-bottom: 12px;
      border-radius: 16px;
      box-sizing: border-box;
    }

    button {
      padding: 18px;
      font-size: 20px;
      border: none;
      font-weight: 700;
      color: white;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      border-radius: 16px;
    }

    button:active { transform: scale(0.97); }

    #captureBtn, #newEntryBtn { background: var(--accent); }
    #saveBtn { background: var(--accent); }
    #clearBtn { background: var(--danger); }

    .note-section {
      text-align: center;
      font-size: 20px;
      margin-bottom: 8px;
      color: #444;
    }

    .note-section div.tip {
      font-style: italic;
      font-size: 16px;
      margin-top: 6px;
      color: #555;
    }

    .note-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
      justify-content: center;
    }

    .note-buttons div { position: relative; flex: 1; }

    .note-buttons button {
      width: 100%;
      color: #fff;
      border: none;
      font-weight: 700;
      opacity: 0.9;
      transition: opacity 0.2s, transform 0.1s, box-shadow 0.2s;
      padding: 16px;
      font-size: 18px;
    }

    .note-buttons button.active {
      outline: 3px solid #00000033;
      opacity: 1;
      transform: scale(1.05);
      box-shadow: 0 5px 12px rgba(0,0,0,0.2);
      border: 2px solid #333;
    }

    .note-buttons span {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      background-color: #f44336;
      border-radius: 50%;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }

    #photoPreview {
      width: 70%;
      max-width: 360px;
      display: none;
      margin: 12px auto;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    #log {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      max-height: 65vh;
      overflow-y: auto;
      padding-bottom: 10px;
    }

    .entry {
      display: flex;
      align-items: center;
      border-radius: 16px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      padding: 12px;
      width: 95%;
      background: var(--card-bg);
      transition: transform 0.2s ease;
    }

    .entry:hover { transform: translateY(-1px); }

    .entry div { flex: 1; }

    .entry strong { font-size: 16px; color: #111; }

    .entry img {
      max-width: 90px;
      max-height: 70px;
      margin-left: 12px;
      border-radius: 12px;
      object-fit: cover;
      transition: transform 0.2s;
    }

    .entry img:active { transform: scale(1.05); }

    @media (max-width: 400px) {
      h2 { font-size: 24px; }
      .entry img { max-width: 30vw; max-height: 22vw; }
      button { font-size: 18px; padding: 14px; }
      .note-section { font-size: 18px; }
      .note-section div.tip { font-size: 15px; }
      .note-buttons button { font-size: 16px; padding: 14px; }
    }

    #installPrompt {
      display:none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #2196f3;
      color: white;
      padding: 16px;
      font-size: 18px;
      text-align: center;
      z-index: 9999;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }

    #installPrompt button {
      margin-left: 12px;
      background: #f44336;
      border: none;
      color: white;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>BP Logger</h2>

<button id="newEntryBtn" style="display:none;">✚ Take Photo of Blood Pressure Monitor Reading</button>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<img id="photoPreview" alt="BP Preview">

<button id="captureBtn">Take Photo of Blood Pressure Monitor Reading</button>

<hr style="border: 2px solid black; border-radius: 4px; margin: 12px 0;">
<div class="note-section">
  <h2>Select Medicine</h2>
  <div class="tip">
    Tip: Here you can choose one or more medicines to record your blood pressure. Use “Pre” to log a reading before your dose, and “Post” to log a reading after taking your medicine.
  </div><br>
</div>

<div class="note-buttons"></div>

<button id="saveBtn">Save</button>
<hr style="border: 2px solid black; border-radius: 4px; margin: 12px 0;">
<div id="log"></div>
<button id="clearBtn">Clear All</button>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const logDiv = document.getElementById('log');
const photoPreview = document.getElementById('photoPreview');
const newEntryBtn = document.getElementById('newEntryBtn');

let entries = JSON.parse(localStorage.getItem('bpEntries')) || [];
let currentNotes = [];
let capturedImage = null;

let medications = JSON.parse(localStorage.getItem('medications')) || [
  { name: "Pre-Lisinopril", color: "#4caf50" },
  { name: "Post-Lisinopril", color: "#9c27b0", textColor: "#fff" }
];

const basicColors = ['#f44336','#2196f3','#4caf50','#ff9800','#9c27b0','#00bcd4','#ffc107'];

function renderNoteButtons() {
  const container = document.querySelector('.note-buttons');
  container.innerHTML = '';
  medications.forEach((med, idx) => {
    const wrapper = document.createElement('div');
    const btn = document.createElement('button');
    btn.textContent = med.name;
    btn.style.backgroundColor = med.color;
    if(med.textColor) btn.style.color = med.textColor;
    btn.classList.add('note-btn');
    btn.onclick = () => toggleNoteSelection(med.name, med.color);
    wrapper.appendChild(btn);

    const delBtn = document.createElement('span');
    delBtn.textContent = '×';
    delBtn.onclick = (e) => {
      e.stopPropagation();
      const code = prompt(`Type 1234 to delete medicine "${med.name}":`);
      if(code === '1234') {
        medications.splice(idx, 1);
        localStorage.setItem('medications', JSON.stringify(medications));
        renderNoteButtons();
      }
    };
    wrapper.appendChild(delBtn);
    container.appendChild(wrapper);
  });

  const addBtnWrapper = document.createElement('div');
  const addBtn = document.createElement('button');
  addBtn.textContent = '+ Add Medicine';
  addBtn.style.fontWeight = '700';
  addBtn.style.fontSize = '18px';
  addBtn.style.backgroundColor = basicColors[Math.floor(Math.random() * basicColors.length)];
  addBtn.onclick = () => {
    const name = prompt('Enter medicine name:');
    if(!name) return;
    const color = basicColors[Math.floor(Math.random() * basicColors.length)];
    medications.push({ name, color });
    localStorage.setItem('medications', JSON.stringify(medications));
    renderNoteButtons();
  };
  addBtnWrapper.appendChild(addBtn);
  container.appendChild(addBtnWrapper);
}

function toggleNoteSelection(name, color) {
  const index = currentNotes.findIndex(n => n.note === name);
  const btns = document.querySelectorAll('.note-btn');
  if(index === -1) {
    currentNotes.push({ note: name, color });
    btns.forEach(b => { if(b.textContent === name) b.classList.add('active'); });
  } else {
    currentNotes.splice(index, 1);
    btns.forEach(b => { if(b.textContent === name) b.classList.remove('active'); });
  }
}

navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
.then(stream => video.srcObject = stream)
.catch(err => alert('Camera access denied'));

// ✅ Take photo (and close camera after capture)
document.getElementById('captureBtn').onclick = () => {
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  let quality = 0.9;
  let dataURL = canvas.toDataURL('image/jpeg', quality);
  while((dataURL.length/1024 > 10) && quality > 0.05) {
    quality -= 0.05;
    dataURL = canvas.toDataURL('image/jpeg', quality);
  }
  capturedImage = dataURL;

  // ✅ Stop the camera completely
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
    video.srcObject = null;
  }

  video.style.display = 'none';
  canvas.style.display = 'none';
  document.getElementById('captureBtn').style.display = 'none';

  photoPreview.src = capturedImage;
  photoPreview.style.display = 'block';
};

// Save entry
document.getElementById('saveBtn').onclick = () => {
  if(!capturedImage) return alert('Please take a photo first');
  if(currentNotes.length === 0) return alert('Please select at least one medicine');

  const now = new Date();
  entries.unshift({
    image: capturedImage,
    notes: currentNotes.slice(),
    time: now.toLocaleString(),
    hour: now.getHours()
  });

  if(entries.length > 30) entries = entries.slice(0,30);
  localStorage.setItem('bpEntries', JSON.stringify(entries));
  renderLog();

  capturedImage = null;
  currentNotes = [];
  document.querySelectorAll('.note-btn').forEach(b => b.classList.remove('active'));
  canvas.style.display = 'none';
  photoPreview.style.display = 'none';
  document.querySelector('.note-section').style.display = 'none';
  document.querySelector('.note-buttons').style.display = 'none';
  document.getElementById('captureBtn').style.display = 'none';
  document.getElementById('saveBtn').style.display = 'none';
  newEntryBtn.style.display = 'block';
};

// Start a new entry
newEntryBtn.onclick = () => {
  newEntryBtn.style.display = 'none';
  photoPreview.style.display = 'none';
  document.querySelector('.note-section').style.display = 'block';
  document.querySelector('.note-buttons').style.display = 'flex';
  document.getElementById('captureBtn').style.display = 'block';
  document.getElementById('saveBtn').style.display = 'block';
  video.style.display = 'block';

  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
  .then(stream => video.srcObject = stream)
  .catch(err => alert('Camera access denied'));
};

// Clear all
document.getElementById('clearBtn').onclick = () => {
  const code = prompt('Enter 1234 to clear all entries:');
  if(code !== '1234') return;
  entries = [];
  localStorage.removeItem('bpEntries');
  renderLog();
};

// Render log
function renderLog() {
  logDiv.innerHTML = entries.map(e => {
    const isLate = e.hour >= 20;
    const bg = isLate ? 'var(--late-bg)' : 'var(--card-bg)';
    const notesHTML = e.notes.map(n => `<span style="color:${n.color}; font-weight:bold; font-size:16px; margin-right:4px;">${n.note}</span>`).join('');
    return `
      <div class="entry" style="background:${bg};">
        <div>
          <strong>${e.time}</strong>
          <div>${notesHTML}</div>
        </div>
        <img src="${e.image}" alt="BP Photo">
      </div>
    `;
  }).join('');
}

renderNoteButtons();
renderLog();
</script>
</body>
</html>
