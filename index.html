<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BP Logger</title>
<style>
  :root {
    --accent: #2196f3;
    --danger: #f44336;
    --bg: #fafafa;
    --card-bg: #fff;
    --late-bg: #e0e0e0;

    --pre-nif: #4caf50;
    --post-nif: #2196f3;
    --post-iso: #f44336;
    --pre-doxa: #ff9800;
    --post-doxa: #9c27b0;
  }

  body {
    font-family: Arial, sans-serif;
    background: var(--bg);
    margin: 0;
    padding: 24px;
    color: #111;
    font-size: 22px;
    line-height: 1.6;
  }

  h2 {
    text-align: center;
    margin-bottom: 24px;
    font-size: 34px;
    font-weight: 900;
  }

  video, canvas, img, button {
    width: 100%;
    margin-bottom: 18px;
    border-radius: 20px;
    box-sizing: border-box;
  }

  button {
    padding: 24px;
    font-size: 26px;
    border: none;
    font-weight: 800;
    color: white;
    cursor: pointer;
    border-radius: 20px;
    transition: background 0.2s, transform 0.1s;
  }

  button:active { transform: scale(0.97); }

  #captureBtn, #saveBtn, #addEntryBtn, #doneBtn { background: var(--accent); }
  #clearBtn { background: var(--danger); }

  .divider {
    height: 8px;
    background: black;
    border-radius: 4px;
    margin: 24px 0;
  }

  .note-section-title {
    text-align: center;
    font-weight: 900;
    font-size: 28px;
    margin-bottom: 8px;
    padding-bottom: 4px;
  }

  .tip-text {
    font-style: italic;
    font-size: 22px;
    color: #555;
    margin-bottom: 16px;
    text-align: center;
  }

  .note-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 16px;
  }

  .note-buttons button {
    flex: 1;
    min-width: 180px;
    padding: 22px;
    color: #fff;
    border: none;
    font-weight: 800;
    font-size: 22px;
    opacity: 0.9;
    transition: opacity 0.2s, transform 0.1s;
  }

  .note-buttons button.active {
    outline: 6px solid #00000080;
    opacity: 1;
    transform: scale(1.03);
  }

  .note-pre-nif { background: var(--pre-nif); }
  .note-post-nif { background: var(--post-nif); }
  .note-post-iso { background: var(--post-iso); }
  .note-pre-doxa { background: var(--pre-doxa); }
  .note-post-doxa { background: var(--post-doxa); }

  /* Selected medicines box */
  .selected-medicine {
    position: relative;
    display: inline-block;
    background: var(--accent);
    color: white;
    font-size: 22px;
    font-weight: 700;
    padding: 12px 16px;
    border-radius: 20px;
    margin: 6px;
  }

  .selected-medicine .delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: red;
    color: white;
    font-weight: 900;
    font-size: 22px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .entry {
    display: flex;
    align-items: center;
    border-radius: 24px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    margin-bottom: 16px;
    padding: 18px;
  }

  .entry div { flex: 1; }
  .entry strong { font-size: 24px; color: #000; display: block; margin-bottom: 6px; }
  .entry span { font-size: 24px; }
  .entry img {
    width: 120px;
    height: auto;
    margin-left: 10px;
    border-radius: 16px;
    object-fit: cover;
  }
</style>
</head>
<body>

<h2>üì∏ BP Logger</h2>

<button id="addEntryBtn">Add Entry</button>

<video id="video" autoplay playsinline style="display:none;"></video>
<img id="preview" style="display:none;" />
<canvas id="canvas" style="display:none;"></canvas>
<button id="captureBtn" style="display:none;">Capture Photo</button>

<div class="divider" style="display:none;" id="topDivider"></div>
<div class="note-section-title" id="noteTitle" style="display:none;">Select the Medicine</div>
<div class="tip-text" id="tipText" style="display:none;">
  Tip: Here you can choose one or more medicines to record your blood pressure. Use ‚ÄúPre‚Äù to log a reading before your dose, and ‚ÄúPost‚Äù to log a reading after taking your medicine. ‚ÄúPre-Lisinopril‚Äù and ‚ÄúPost-Lisinopril‚Äù are shown as examples.
</div>

<div class="note-buttons" id="noteButtons" style="display:none;">
  <button class="note-btn note-pre-nif">Pre-Nifedipine</button>
  <button class="note-btn note-post-nif">Post-Nifedipine</button>
  <button class="note-btn note-post-iso">Post-Isosorbide</button>
  <button class="note-btn note-pre-doxa">Pre-Doxazosin</button>
  <button class="note-btn note-post-doxa">Post-Doxazosin</button>
</div>

<div id="selectedContainer" style="margin-bottom:16px;"></div>

<div class="divider" style="display:none;" id="bottomDivider"></div>

<button id="saveBtn" style="display:none;">Save Entry</button>
<button id="doneBtn" style="display:none;">Done</button>

<div id="log"></div>
<button id="clearBtn">Clear All</button>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const preview = document.getElementById('preview');
const captureBtn = document.getElementById('captureBtn');
const saveBtn = document.getElementById('saveBtn');
const doneBtn = document.getElementById('doneBtn');
const addEntryBtn = document.getElementById('addEntryBtn');
const noteButtonsDiv = document.getElementById('noteButtons');
const noteTitle = document.getElementById('noteTitle');
const topDivider = document.getElementById('topDivider');
const bottomDivider = document.getElementById('bottomDivider');
const tipText = document.getElementById('tipText');
const selectedContainer = document.getElementById('selectedContainer');
const logDiv = document.getElementById('log');

let entries = JSON.parse(localStorage.getItem('bpEntries')) || [];
let selectedNotes = [];
let capturedImage = null;
let stream = null;

renderLog();

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    video.style.display = 'block';
    captureBtn.style.display = 'block';
    saveBtn.style.display = 'block';
    doneBtn.style.display = 'block';
    noteButtonsDiv.style.display = 'flex';
    noteTitle.style.display = 'block';
    topDivider.style.display = 'block';
    bottomDivider.style.display = 'block';
    tipText.style.display = 'block';
    selectedContainer.innerHTML = '';
    capturedImage = null;
    selectedNotes = [];
    document.querySelectorAll('.note-btn').forEach(btn => btn.classList.remove('active'));
  } catch {
    alert('Camera access denied');
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
}

addEntryBtn.onclick = () => {
  addEntryBtn.style.display = 'none';
  startCamera();
};

// Medicine selection
document.querySelectorAll('.note-btn').forEach(btn => {
  btn.onclick = () => {
    const note = btn.textContent;
    if (selectedNotes.includes(note)) return; // already added

    selectedNotes.push(note);
    btn.classList.add('active');

    const medDiv = document.createElement('div');
    medDiv.className = 'selected-medicine';
    medDiv.textContent = note;

    const delBtn = document.createElement('div');
    delBtn.className = 'delete-btn';
    delBtn.textContent = '√ó';
    delBtn.onclick = () => {
      selectedContainer.removeChild(medDiv);
      selectedNotes = selectedNotes.filter(n => n !== note);
      btn.classList.remove('active');
    };

    medDiv.appendChild(delBtn);
    selectedContainer.appendChild(medDiv);
  };
});

captureBtn.onclick = async () => {
  if (video.style.display !== 'none') {
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    capturedImage = canvas.toDataURL('image/png');

    stopCamera();
    video.style.display = 'none';
    preview.src = capturedImage;
    preview.style.display = 'block';
    captureBtn.textContent = 'Retake Photo';
  } else {
    startCamera();
    captureBtn.textContent = 'Capture Photo';
  }
};

saveBtn.onclick = () => {
  if (!capturedImage) return alert('Please capture a photo');
  if (selectedNotes.length === 0) return alert('Please select at least one medicine');

  const now = new Date();
  const combinedNotes = selectedNotes.join(', ');

  entries.unshift({
    image: capturedImage,
    note: combinedNotes,
    color: 'var(--accent)',
    time: now.toLocaleString(),
    hour: now.getHours()
  });

  if (entries.length > 30) entries = entries.slice(0, 30);
  localStorage.setItem('bpEntries', JSON.stringify(entries));
  renderLog();

  preview.style.display = 'none';
  captureBtn.textContent = 'Capture Photo';
  capturedImage = null;
  selectedNotes = [];
  selectedContainer.innerHTML = '';
  document.querySelectorAll('.note-btn').forEach(btn => btn.classList.remove('active'));
  startCamera();
};

doneBtn.onclick = () => {
  stopCamera();
  video.style.display = 'none';
  preview.style.display = 'none';
  captureBtn.style.display = 'none';
  saveBtn.style.display = 'none';
  doneBtn.style.display = 'none';
  noteButtonsDiv.style.display = 'none';
  noteTitle.style.display = 'none';
  topDivider.style.display = 'none';
  bottomDivider.style.display = 'none';
  tipText.style.display = 'none';
  selectedContainer.innerHTML = '';
  addEntryBtn.style.display = 'block';
};

document.getElementById('clearBtn').onclick = () => {
  const code = prompt('Enter 1234 to clear all entries:');
  if (code !== '1234') return;
  entries = [];
  localStorage.removeItem('bpEntries');
  renderLog();
};

function renderLog() {
  logDiv.innerHTML = entries.map(e => {
    const isLate = e.hour >= 20;
    const bg = isLate ? 'var(--late-bg)' : 'var(--card-bg)';
    return `
      <div class="entry" style="background:${bg};">
        <div>
          <strong>${e.time}</strong>
          <span style="color:${e.color}; font-weight:bold; display:block;">
            ${e.note}
          </span>
        </div>
        <img src="${e.image}" alt="BP Photo">
      </div>
    `;
  }).join('');
}
</script>
</body>
</html>
